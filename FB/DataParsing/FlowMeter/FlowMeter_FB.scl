FUNCTION_BLOCK "FlowMeter_FB"
{ S7_Optimized_Access := 'TRUE' }
VERSION : 0.1
   VAR_INPUT 
      IN_RawData : "UDT_FlowMeter_Raw";   // 485流量计原始数据
      IN_FillingControl : Bool;   // 充装控制信号
      IN_CompressorPower : Real;   // 压缩机功率读数
   END_VAR

   VAR_OUTPUT 
      OUT_Data : "UDT_FlowMeter_Data";   // 处理后的流量计数据
      OUT_Filling : Bool;   // 充装状态
      OUT_FillingTime : Real;   // 当前充装时间（分钟）
   END_VAR

   VAR 
      R_TRIG_Instance {InstructionName := 'R_TRIG'; LibVersion := '1.0'; S7_SetPoint := 'False'} : R_TRIG;
      F_TRIG_Instance {InstructionName := 'F_TRIG'; LibVersion := '1.0'} : F_TRIG;
      rInitialFlow { S7_SetPoint := 'True'} : Real;   // 初始流量读数
      rFinalFlow { S7_SetPoint := 'True'} : Real;   // 最终流量读数
      rStartTime : LReal;   // 开始时间
      rCurrentTime : LReal;   // 当前时间
      SysTime {InstructionName := 'DTL'; LibVersion := '1.0'} : DTL;   // 系统时间
      rPowerInitial : Real;   // 初始功率读数
   END_VAR

BEGIN
    #R_TRIG_Instance(CLK := #IN_FillingControl);
    #F_TRIG_Instance(CLK := #IN_FillingControl);
    
    REGION 充装质量计算
        IF #R_TRIG_Instance.Q AND NOT #OUT_Filling THEN
            #rInitialFlow := #IN_RawData.IN_TotalMassFlow;
            #rPowerInitial := #IN_CompressorPower;
            #OUT_Filling := TRUE;
            #OUT_Data.OUT_CurrentMass := 0.0;
            #OUT_Data.OUT_PowerConsumption := 0.0;
        END_IF;
        
        // Calculate current filling mass in real-time
        IF #OUT_Filling THEN
            #OUT_Data.OUT_CurrentMass := (#IN_RawData.IN_TotalMassFlow - #rInitialFlow) / 1000;
            #OUT_Data.OUT_PowerConsumption := #IN_CompressorPower - #rPowerInitial;
        END_IF;
        
        // Stop filling on falling edge
        IF #F_TRIG_Instance.Q AND #OUT_Filling THEN
            #rFinalFlow := #IN_RawData.IN_TotalMassFlow;
            #OUT_Data.OUT_CurrentMass := (#IN_RawData.IN_TotalMassFlow - #rInitialFlow) / 1000;
            #OUT_Data.OUT_PowerConsumption := #IN_CompressorPower - #rPowerInitial;
            #OUT_Filling := FALSE;
        END_IF;
    END_REGION
    
    #OUT_Data.OUT_TotalMass := #IN_RawData.IN_TotalMassFlow/1000;
    #OUT_Data.OUT_FlowRate := #IN_RawData.IN_MassFlowRate*0.06;
    
END_FUNCTION_BLOCK